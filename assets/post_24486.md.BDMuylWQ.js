import{_ as i,c as a,o as n,aj as h}from"./chunks/framework.Dc3YHBOS.js";const c=JSON.parse('{"title":"多台服务器使用 Rsync 同步代码","description":"","frontmatter":{"date":"2020-03-08 21:33:20","author":"lzw"},"headers":[],"relativePath":"post/24486.md","filePath":"post/2020/03/24486.md","lastUpdated":1710426988000}'),l={name:"post/24486.md"};function t(p,s,k,e,r,d){return n(),a("div",null,[...s[0]||(s[0]=[h(`<h1 id="多台服务器使用-rsync-同步代码" tabindex="-1">多台服务器使用 Rsync 同步代码 <a class="header-anchor" href="#多台服务器使用-rsync-同步代码" aria-label="Permalink to “多台服务器使用 Rsync 同步代码”">​</a></h1><p>当多台服务器使用负载均衡等解决方案时，各服务器代码同步又是另一个问题，这时使用 Rsync 是一个常用的方案。这里以两台服务器为例</p><blockquote><p>主服务器 A ：192.168.0.2</p><p>辅服务器 B ：192.168.0.3</p></blockquote><h2 id="安装配置-rsync" tabindex="-1">安装配置 Rsync <a class="header-anchor" href="#安装配置-rsync" aria-label="Permalink to “安装配置 Rsync”">​</a></h2><p>安装 Rsync 并查看版本信息</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsync</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -version</span></span></code></pre></div><p>启动和停止 Rsync</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/bin/rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --daemon</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --config=/etc/rsyncd.conf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ps</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -ef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsync</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 12521</span></span></code></pre></div><p><strong>配置主服务器 A</strong>， 首先简单配置下 Rsync，使用命令 <code>vi /etc/rsyncd.conf</code></p><div class="language-ini"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 运行 Rsync 守护进程用户和组</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = nobody</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">gid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = nobody</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 允许最大连接数，就是预期多少台服务器链接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">max </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">connections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 4</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 只读模式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">read </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">only</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = true</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 预期链接的 IP，多个用逗号隔开</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># hosts allow = 202.207.177.180</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 现在是允许所有的服务器都能连</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hosts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">allow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = *</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">transfer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">logging</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = %h %o %f %l %b</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 日志文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = /var/log/rsyncd.log</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">slp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">refresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 300</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 进程文件位置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = /var/run/rsyncd.pid</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">lock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = /var/run/rsyncd.lock</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[test]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># A 服务器需要同步的目录</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = /www/wwwroot/test</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">read </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">only</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = false</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 允许的认证用户</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">auth </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = root</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 密码文件位置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">secrets </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = /etc/rsyncd.password</span></span></code></pre></div><p>接着设置上面配置文件中的密码文件 <code>vim rsyncd.password</code> 添加【user:password】格式的内容如：<code>root:123456</code>，并设置 600 权限，这点非常重要</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -R</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsyncd.password</span></span></code></pre></div><p><strong>配置辅服务器 B</strong>，这里只需要添加密码文件 <code>vim rsyncd.password</code> 添加【password】格式的内容如：<code>123456</code></p><p><strong>添加开机启动</strong>，防止服务器重启或者宕机修复好之后，需要手动重启服务</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/rc.local</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/bin/rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --daemon</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --config=/ect/rsyncd.conf</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   #开机自动运行</span></span></code></pre></div><h2 id="代码同步" tabindex="-1">代码同步 <a class="header-anchor" href="#代码同步" aria-label="Permalink to “代码同步”">​</a></h2><p>配置好了 Rsync，现在就来实现服务器 B 从服务器 A 同步代码，执行以下命令</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -vzrtopg</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --progress</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root@192.168.0.2::test</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /www/wwwroot/test</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --password-file=/etc/rsyncd.password</span></span></code></pre></div><blockquote><p><code>root</code> 对应服务器 A 配置文件 rsyncd.conf 中的 auth users = root</p><p><code>192.168.0.2</code> 应服务器 A 的 IP</p><p><code>test</code> 对应服务器 A 配置文件 rsyncd.conf 中的 [test]</p><p><code>/www/wwwroot/test</code> 是服务器 B 存放同步代码的目录</p><p><code>/etc/rsyncd.password</code> 是服务器 B 的密码文件</p></blockquote><p>以上命令执行一次，同步一次，需要用到 crontab 计划任务来做到实时同步，新建 shell 脚本 <code>vim /root/rsyncd.sh</code></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PATH</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 间隔的秒数，不能大于60</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">step</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (( i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">step) )); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    $(rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -vzrtopg</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --progress</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root@192.168.0.2::test</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /www/wwwroot/test</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --password-file=/etc/rsyncd.password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $step</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><p>然后在服务器 B 添加 crontab 定时任务，执行 <code>crontab -e</code></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sh /root/rsyncd.sh </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /dev/null </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">2&gt;&amp;1</span></span></code></pre></div><p>OK，大功告成，赶紧去试试吧！</p><p>参考： <a href="https://blog.csdn.net/oljuydfcg/article/details/91639416" target="_blank" rel="noreferrer">https://blog.csdn.net/oljuydfcg/article/details/91639416</a></p>`,25)])])}const o=i(l,[["render",t]]);export{c as __pageData,o as default};
